<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fundus Imaging Viewer (PACS)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons (React Version) -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.468.0/dist/lucide-react.umd.min.js"></script>

    <style>
        body {
            background-color: #000000;
            color: #e5e5e5;
            overflow: hidden; /* Prevent body scroll */
        }
        
        /* Custom Scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #666; 
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Red-Free SVG Filter Definition -->
    <svg style="display: none;">
        <defs>
            <filter id="red-free-filter">
                <feColorMatrix type="matrix" 
                    values="0 0.5 0.5 0 0
                            0 0.5 0.5 0 0
                            0 0.5 0.5 0 0
                            0 0 0 1 0"/>
            </filter>
        </defs>
    </svg>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // Safely access lucideReact from window object
        const lucide = window.lucideReact || {};
        const { 
            Search, ZoomIn, ZoomOut, Sun, Contrast, Eye, 
            RefreshCw, Layout, Smartphone, Grid3X3, 
            ArrowLeftRight, FileImage, Calendar, FolderOpen,
            Hand, SlidersHorizontal, CheckSquare, Square // Ensure Square is imported
        } = lucide;

        // Fallback component if icon is missing
        const IconFallback = () => <span className="w-4 h-4 block bg-gray-700 rounded"></span>;
        
        // Wrap icons to safely handle missing icons during load
        const SafeIcon = (IconComponent, props) => {
            return IconComponent ? <IconComponent {...props} /> : <IconFallback />;
        };

        // --- Mock Data Generation (Default) ---
        const generateMockFiles = () => {
            const files = [];
            const patientIDs = ['01424', '09932', '10234'];
            const dates = ['20251202', '20251128', '20251015'];
            
            patientIDs.forEach(pid => {
                dates.forEach(date => {
                    files.push(`${pid}_${date}_080330_Color_R_001.jpg`);
                    files.push(`${pid}_${date}_080345_Color_R_002.jpg`);
                    files.push(`${pid}_${date}_080510_Color_L_001.jpg`);
                    files.push(`${pid}_${date}_080525_Color_L_002.jpg`);
                });
            });
            return files;
        };

        const DEFAULT_FILES = generateMockFiles();

        // --- Helper Functions ---
        const parseFilename = (filename) => {
            const nameOnly = filename.split('/').pop().split('\\').pop(); 
            const parts = nameOnly.split('_');
            
            if (parts.length < 5) return null; 

            const mrn = parts[0];
            const dateStr = parts[1]; // YYYYMMDD
            
            if (dateStr.length !== 8) return null;

            const timeStr = parts[2];
            const sideCode = parts[4]; 
            
            const date = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
            const side = (sideCode === 'R' || sideCode === 'OD') ? 'OD' : 'OS'; 

            return {
                filename: filename, 
                nameOnly: nameOnly,
                mrn,
                date,
                side, 
                originalSide: sideCode,
                id: filename,
                fileObj: null
            };
        };

        // --- Components ---

        // 1. Sidebar Component
        const Sidebar = ({ files, onSelect, onDateSelect, onImportFiles, selectedFiles }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [groupedFiles, setGroupedFiles] = useState({});
            const fileInputRef = useRef(null);

            const isSelected = (fileId) => selectedFiles.some(f => f.id === fileId);

            useEffect(() => {
                const parsed = files.map(f => {
                    const name = typeof f === 'string' ? f : f.name;
                    const meta = parseFilename(name);
                    if (meta && typeof f !== 'string') {
                        meta.fileObj = f;
                    }
                    return meta;
                }).filter(Boolean);
                
                const filtered = searchTerm 
                    ? parsed.filter(f => f.mrn.includes(searchTerm))
                    : [];

                const groups = {};
                filtered.forEach(f => {
                    if (!groups[f.date]) groups[f.date] = [];
                    groups[f.date].push(f);
                });
                
                setGroupedFiles(groups);
            }, [files, searchTerm]);

            const handleFolderSelect = (e) => {
                const selectedFiles = Array.from(e.target.files);
                const imageFiles = selectedFiles.filter(f => f.name.match(/\.(jpg|jpeg|png)$/i));
                if (imageFiles.length > 0) {
                    onImportFiles(imageFiles);
                }
            };

            return (
                <div className="w-80 bg-neutral-900 border-r border-neutral-700 flex flex-col h-screen text-sm shadow-2xl z-20">
                    {/* Header */}
                    <div className="p-5 border-b border-neutral-700 bg-neutral-800 space-y-4">
                        <h1 className="text-xl font-bold text-white flex items-center gap-2 mb-2">
                            {SafeIcon(Eye, { className: "text-blue-500", size: 24 })}
                            Fundus PACS
                        </h1>
                        
                        {/* Import Button */}
                        <div 
                            className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-3 rounded-lg cursor-pointer flex items-center justify-center gap-2 transition-all shadow-md border border-blue-400 font-bold text-base active:scale-95"
                            onClick={() => fileInputRef.current?.click()}
                        >
                            {SafeIcon(FolderOpen, { size: 20 })}
                            <span>載入本機資料夾</span>
                            <input 
                                type="file" 
                                ref={fileInputRef}
                                className="hidden"
                                {...{ webkitdirectory: "", directory: "" }}
                                multiple
                                onChange={handleFolderSelect}
                            />
                        </div>

                        {/* Search Box */}
                        <div className="space-y-1">
                            <label className="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">搜尋病歷</label>
                            <div className="relative group">
                                <div className="absolute left-3 top-3 text-gray-400 group-focus-within:text-blue-400 transition-colors">
                                    {SafeIcon(Search, { size: 18 })}
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="輸入病歷號 (例: 01424)" 
                                    className="w-full bg-neutral-900 border-2 border-neutral-600 rounded-lg p-2.5 pl-10 text-white focus:border-blue-500 focus:outline-none placeholder-neutral-500 text-base transition-colors"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                        </div>
                    </div>

                    {/* List */}
                    <div className="flex-1 overflow-y-auto p-2 bg-neutral-900">
                        {Object.keys(groupedFiles).length === 0 && (
                            <div className="text-center text-neutral-500 mt-10 px-4">
                                {files.length === DEFAULT_FILES.length && typeof files[0] === 'string' 
                                    ? 
                                    <div className="space-y-2">
                                        <p className="text-lg">尚無資料</p>
                                        <p className="text-sm">請點擊上方藍色按鈕匯入資料夾，或搜尋預設範例 (01424)</p>
                                    </div>
                                    : "找不到符合條件的影像"}
                            </div>
                        )}

                        {Object.keys(groupedFiles).sort((a,b) => b.localeCompare(a)).map(date => (
                            <div key={date} className="mb-4">
                                {/* Date Header - Double Click Event Added */}
                                <div 
                                    className="flex items-center justify-between gap-2 text-gray-300 px-3 py-1.5 bg-neutral-800 border-l-4 border-blue-600 rounded-r mb-2 sticky top-0 shadow-md z-10 cursor-pointer hover:bg-neutral-700 transition-colors select-none"
                                    title="雙擊此處開啟當日雙眼影像 (OU)"
                                    onDoubleClick={() => onDateSelect(groupedFiles[date])}
                                >
                                    <div className="flex items-center gap-2">
                                        {SafeIcon(Calendar, { size: 14 })}
                                        <span className="font-mono font-bold">{date}</span>
                                    </div>
                                    <span className="text-[10px] text-gray-500 bg-black/20 px-1 rounded">OU View</span>
                                </div>

                                <div className="space-y-1 pl-2">
                                    {groupedFiles[date].map(file => {
                                        const active = isSelected(file.id);
                                        return (
                                            <div 
                                                key={file.id}
                                                className={`group flex items-center justify-between p-2 rounded-lg cursor-pointer transition-colors border mb-1
                                                    ${active 
                                                        ? 'bg-blue-900/40 border-blue-500/50 hover:bg-blue-900/60' 
                                                        : 'hover:bg-neutral-800 border-transparent hover:border-neutral-700'}`}
                                                onDoubleClick={() => onSelect(file, groupedFiles[date])}
                                            >
                                                <div className="flex items-center gap-3 overflow-hidden">
                                                    {/* Explicit Checkbox Visual */}
                                                    <div className={`flex-shrink-0 transition-colors ${active ? 'text-blue-400' : 'text-neutral-600 group-hover:text-neutral-500'}`}>
                                                        {active 
                                                            ? SafeIcon(CheckSquare, { size: 18 }) 
                                                            : SafeIcon(Square, { size: 18 })
                                                        }
                                                    </div>
                                                    <span className={`font-mono truncate text-sm ${active ? 'text-white font-bold' : 'text-gray-300'}`}>
                                                        {file.mrn}
                                                    </span>
                                                </div>
                                                <span className={`flex-shrink-0 text-xs font-bold px-2 py-0.5 rounded-full ${file.side === 'OD' ? 'bg-blue-900/50 text-blue-300 border border-blue-800' : 'bg-yellow-900/50 text-yellow-300 border border-yellow-800'}`}>
                                                    {file.side}
                                                </span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 2. Toolbar Component
        const Toolbar = ({ settings, setSettings, onReset, viewMode, setViewMode, activeTool, setActiveTool }) => {
            const updateSetting = (key, value) => {
                setSettings(prev => ({ ...prev, [key]: value }));
            };

            return (
                <div className="h-16 bg-neutral-900 border-b border-neutral-700 flex items-center px-4 gap-4 justify-between select-none shadow-md z-10 relative">
                    
                    {/* Left: Tools */}
                    <div className="flex items-center gap-4">
                        <div className="flex items-center gap-1 bg-neutral-800 p-1 rounded-lg border border-neutral-700">
                            <button 
                                className={`p-2 rounded flex items-center gap-2 transition-colors ${viewMode === 'single' ? 'bg-neutral-700 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                onClick={() => setViewMode('single')}
                                title="單張檢視"
                            >
                                {SafeIcon(Smartphone, { size: 18 })}
                            </button>
                            <button 
                                className={`p-2 rounded flex items-center gap-2 transition-colors ${viewMode === 'split' ? 'bg-neutral-700 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                onClick={() => setViewMode('split')}
                                title="雙眼併呈 (OU)"
                            >
                                {SafeIcon(Layout, { size: 18 })}
                            </button>
                        </div>

                        <div className="w-px h-8 bg-neutral-700"></div>

                        <div className="flex items-center gap-1 bg-neutral-800 p-1 rounded-lg border border-neutral-700">
                            <button 
                                className={`p-2 rounded flex items-center gap-2 transition-colors ${activeTool === 'pan' ? 'bg-blue-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                onClick={() => setActiveTool('pan')}
                                title="移動模式"
                            >
                                {SafeIcon(Hand, { size: 18 })}
                                <span className="text-xs font-bold hidden xl:inline">移動</span>
                            </button>
                            <button 
                                className={`p-2 rounded flex items-center gap-2 transition-colors ${activeTool === 'adjust' ? 'bg-blue-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                onClick={() => setActiveTool('adjust')}
                                title="調整模式"
                            >
                                {SafeIcon(SlidersHorizontal, { size: 18 })}
                                <span className="text-xs font-bold hidden xl:inline">調整</span>
                            </button>
                        </div>
                    </div>

                    {/* Middle: Sliders */}
                    <div className="hidden lg:flex items-center gap-6 flex-1 justify-center max-w-lg opacity-80 hover:opacity-100 transition-opacity">
                        <div className="flex items-center gap-2 w-full">
                            {SafeIcon(Sun, { size: 18, className: "text-yellow-500" })}
                            <div className="flex flex-col w-full">
                                <span className="text-[10px] text-gray-400 uppercase">Brightness ({Math.round(settings.brightness)}%)</span>
                                <input 
                                    type="range" min="0" max="200" value={settings.brightness} 
                                    onChange={(e) => updateSetting('brightness', Number(e.target.value))}
                                    className="w-full accent-yellow-500 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                />
                            </div>
                        </div>
                        <div className="flex items-center gap-2 w-full">
                            {SafeIcon(Contrast, { size: 18, className: "text-gray-100" })}
                             <div className="flex flex-col w-full">
                                <span className="text-[10px] text-gray-400 uppercase">Contrast ({Math.round(settings.contrast)}%)</span>
                                <input 
                                    type="range" min="0" max="200" value={settings.contrast} 
                                    onChange={(e) => updateSetting('contrast', Number(e.target.value))}
                                    className="w-full accent-gray-400 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                />
                            </div>
                        </div>
                    </div>

                    {/* Right: Actions */}
                    <div className="flex items-center gap-2">
                         <button 
                            className={`px-3 py-1.5 rounded text-xs border whitespace-nowrap font-medium transition-colors ${settings.redFree ? 'bg-green-900/80 border-green-500 text-green-300' : 'border-neutral-600 text-gray-400 hover:bg-neutral-800 hover:border-neutral-500'}`}
                            onClick={() => updateSetting('redFree', !settings.redFree)}
                            title="Digital Red-Free Filter"
                        >
                            Red-Free
                        </button>
                        <button 
                            className={`px-3 py-1.5 rounded text-xs border font-medium transition-colors ${settings.invert ? 'bg-white text-black border-white' : 'border-neutral-600 text-gray-400 hover:bg-neutral-800 hover:border-neutral-500'}`}
                            onClick={() => updateSetting('invert', !settings.invert)}
                        >
                            Invert
                        </button>
                        
                        <div className="w-px h-8 bg-neutral-700 mx-2 hidden md:block"></div>
                        
                        {/* Zoom Buttons - Explicit Colors */}
                        <button 
                            className="p-2 text-gray-200 hover:text-white hover:bg-neutral-800 rounded bg-neutral-800/50 border border-neutral-700 mx-0.5"
                            onClick={() => updateSetting('zoom', settings.zoom + 0.1)}
                            title="Zoom In"
                        >
                            {SafeIcon(ZoomIn, { size: 20 })}
                        </button>
                        <div className="text-xs font-mono w-10 text-center text-gray-400 hidden md:block select-none">{Math.round(settings.zoom * 100)}%</div>
                        <button 
                            className="p-2 text-gray-200 hover:text-white hover:bg-neutral-800 rounded bg-neutral-800/50 border border-neutral-700 mx-0.5"
                            onClick={() => updateSetting('zoom', Math.max(0.1, settings.zoom - 0.1))}
                            title="Zoom Out"
                        >
                            {SafeIcon(ZoomOut, { size: 20 })}
                        </button>
                        
                        <button 
                            className="p-2 text-red-400 hover:bg-red-900/20 hover:text-red-300 rounded flex items-center gap-1 transition-colors ml-2"
                            onClick={onReset}
                            title="Reset All (R)"
                        >
                            {SafeIcon(RefreshCw, { size: 18 })} <span className="text-xs hidden md:inline font-medium">Reset</span>
                        </button>
                    </div>
                </div>
            );
        };

        // 3. Image Canvas (Unchanged Logic, just passed props)
        const ImageCanvas = ({ file, settings, activeTool, onUpdateSettings }) => {
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [imgSrc, setImgSrc] = useState('');
            
            const dragStart = useRef({ x: 0, y: 0 });
            const startSettings = useRef({ brightness: 100, contrast: 100, panX: 0, panY: 0 });
            
            useEffect(() => {
                if (file.fileObj) {
                    const url = URL.createObjectURL(file.fileObj);
                    setImgSrc(url);
                    return () => URL.revokeObjectURL(url); 
                } else {
                    setImgSrc(file.filename); 
                }
            }, [file]);

            useEffect(() => {
                if (settings.zoom === 1) setPan({ x: 0, y: 0 });
            }, [settings.zoom]);

            const handleWheel = (e) => {
                const scaleAmount = -e.deltaY * 0.001;
                const newZoom = Math.min(Math.max(0.1, settings.zoom + scaleAmount), 5);
                onUpdateSettings('zoom', newZoom);
            };

            const handleMouseDown = (e) => {
                setIsDragging(true);
                dragStart.current = { x: e.clientX, y: e.clientY };
                startSettings.current = {
                    brightness: settings.brightness,
                    contrast: settings.contrast,
                    panX: pan.x,
                    panY: pan.y
                };
                e.preventDefault(); 
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;

                const deltaX = e.clientX - dragStart.current.x;
                const deltaY = e.clientY - dragStart.current.y;

                if (activeTool === 'pan') {
                    setPan({
                        x: startSettings.current.panX + deltaX,
                        y: startSettings.current.panY + deltaY
                    });
                } else if (activeTool === 'adjust') {
                    const sensitivity = 0.5;
                    const newBrightness = Math.min(Math.max(0, startSettings.current.brightness - (deltaY * sensitivity)), 200);
                    const newContrast = Math.min(Math.max(0, startSettings.current.contrast + (deltaX * sensitivity)), 200);
                    onUpdateSettings('brightness', newBrightness);
                    onUpdateSettings('contrast', newContrast);
                }
            };

            const handleMouseUp = () => setIsDragging(false);

            const handleImageError = () => {
                const dummyColor = file.side === 'OD' ? '2563EB' : 'EAB308';
                setImgSrc(`https://placehold.co/1200x900/050505/${dummyColor}?text=${file.side}+Image+Missing\n${file.nameOnly}`);
            };

            const filterStyle = {
                filter: `
                    brightness(${settings.brightness}%) 
                    contrast(${settings.contrast}%) 
                    invert(${settings.invert ? 1 : 0})
                    ${settings.redFree ? 'url(#red-free-filter)' : ''} 
                `,
                transform: `translate(${pan.x}px, ${pan.y}px) scale(${settings.zoom})`,
                transformOrigin: 'center',
                transition: isDragging ? 'none' : 'transform 0.1s ease-out, filter 0.1s',
                cursor: activeTool === 'pan' 
                        ? (isDragging ? 'grabbing' : 'grab') 
                        : 'crosshair'
            };

            return (
                <div 
                    className="relative w-full h-full overflow-hidden bg-black flex items-center justify-center border border-neutral-800"
                    onMouseDown={handleMouseDown}
                    onMouseMove={handleMouseMove}
                    onMouseUp={handleMouseUp}
                    onMouseLeave={handleMouseUp}
                    onWheel={handleWheel}
                >
                    <img 
                        src={imgSrc} 
                        alt={file.filename}
                        className="max-w-full max-h-full object-contain pointer-events-none select-none"
                        style={filterStyle}
                        onError={handleImageError}
                    />

                    <div className="absolute top-4 left-4 text-xs font-mono text-white/80 pointer-events-none no-select bg-black/40 p-2 rounded backdrop-blur-sm border border-white/10">
                        <p><span className="text-gray-400">ID:</span> {file.mrn}</p>
                        <p><span className="text-gray-400">DATE:</span> {file.date}</p>
                        <p className={`text-2xl font-bold mt-1 ${file.side === 'OD' ? 'text-blue-500' : 'text-yellow-500'}`}>
                            {file.side}
                        </p>
                    </div>

                    <div className="absolute bottom-4 right-4 text-white/50 text-xs pointer-events-none flex flex-col items-end gap-1">
                        <span className="bg-black/50 px-2 py-1 rounded">
                            {activeTool === 'pan' ? 'Move Tool' : 'W/L Tool'}
                        </span>
                        <span>Zoom: {Math.round(settings.zoom * 100)}%</span>
                    </div>
                </div>
            );
        };

        // 4. Main App Container
        const App = () => {
            const [allFiles, setAllFiles] = useState(DEFAULT_FILES);
            const [selectedFiles, setSelectedFiles] = useState([]);
            const [viewMode, setViewMode] = useState('single');
            const [activeTool, setActiveTool] = useState('pan');
            
            const [imageSettings, setImageSettings] = useState({
                brightness: 100,
                contrast: 100,
                zoom: 1,
                invert: false,
                redFree: false
            });

            const updateImageSetting = (key, value) => {
                setImageSettings(prev => ({ ...prev, [key]: value }));
            };

            const handleReset = () => {
                setImageSettings({
                    brightness: 100,
                    contrast: 100,
                    zoom: 1,
                    invert: false,
                    redFree: false
                });
            };

            const handleFileSelect = (file, groupFiles) => {
                if (viewMode === 'single') {
                    setSelectedFiles([file]);
                } else {
                    const currentSide = file.side;
                    const targetSide = currentSide === 'OD' ? 'OS' : 'OD';
                    const pair = groupFiles.find(f => f.side === targetSide);
                    
                    const newSelection = [];
                    const odFile = file.side === 'OD' ? file : pair;
                    const osFile = file.side === 'OS' ? file : pair;

                    if (odFile) newSelection.push(odFile);
                    if (osFile) newSelection.push(osFile);
                    if (newSelection.length === 0) newSelection.push(file);

                    setSelectedFiles(newSelection);
                }
            };

            // New Feature: Double Click Date to Open OU
            const handleDateSelect = (filesInDate) => {
                const od = filesInDate.find(f => f.side === 'OD');
                const os = filesInDate.find(f => f.side === 'OS');
                
                const newSelection = [];
                if (od) newSelection.push(od);
                if (os) newSelection.push(os);
                
                // If only one side exists, show that one
                if (newSelection.length === 0 && filesInDate.length > 0) {
                    newSelection.push(filesInDate[0]);
                }

                if (newSelection.length > 0) {
                    setSelectedFiles(newSelection);
                    // Force split view if we found 2 images, or keep user preference if 1
                    if (newSelection.length > 1) {
                        setViewMode('split');
                    }
                }
            };

            const handleImportFiles = (files) => {
                setAllFiles(files);
                setSelectedFiles([]);
            };

            useEffect(() => {
                if (selectedFiles.length > 0) {
                   if (viewMode === 'single' && selectedFiles.length > 1) {
                       setSelectedFiles([selectedFiles[0]]);
                   }
                }
            }, [viewMode]);

            return (
                <div className="flex h-screen w-screen bg-black text-gray-100 font-sans overflow-hidden">
                    <Sidebar 
                        files={allFiles} 
                        onSelect={handleFileSelect}
                        onDateSelect={handleDateSelect}
                        onImportFiles={handleImportFiles}
                        selectedFiles={selectedFiles}
                    />

                    <div className="flex-1 flex flex-col h-full min-w-0">
                        <Toolbar 
                            settings={imageSettings} 
                            setSettings={setImageSettings} 
                            onReset={handleReset}
                            viewMode={viewMode}
                            setViewMode={setViewMode}
                            activeTool={activeTool}
                            setActiveTool={setActiveTool}
                        />

                        <div className="flex-1 relative bg-black p-1">
                            {selectedFiles.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-neutral-600 select-none space-y-4">
                                    <div className="p-6 bg-neutral-900 rounded-full">
                                        {SafeIcon(Eye, { size: 64, className: "opacity-50 text-blue-500" })}
                                    </div>
                                    <div className="text-center">
                                        <p className="text-xl font-medium text-gray-300">請選擇影像以開始檢視</p>
                                        <p className="text-sm text-gray-500 mt-2">
                                            雙擊左側列表的項目，或使用左上角的<br/>「載入本機資料夾」匯入您的影像
                                        </p>
                                    </div>
                                </div>
                            ) : (
                                <div className={`h-full w-full grid ${viewMode === 'split' ? 'grid-cols-2 gap-1' : 'grid-cols-1'}`}>
                                    {selectedFiles.map((file) => (
                                        <ImageCanvas 
                                            key={file.id} 
                                            file={file} 
                                            settings={imageSettings}
                                            activeTool={activeTool}
                                            onUpdateSettings={updateImageSetting}
                                        />
                                    ))}
                                    {viewMode === 'split' && selectedFiles.length === 1 && (
                                        <div className="bg-neutral-900 border border-neutral-800 flex items-center justify-center text-neutral-500 text-sm flex-col gap-2">
                                            {SafeIcon(ArrowLeftRight, { size: 24, className: "opacity-50" })}
                                            <span>No Contralateral Image</span>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>